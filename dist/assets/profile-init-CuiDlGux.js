const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-JTWqLALI.js","assets/index-B2Jmo72E.css","assets/affiliate-signup-D6nWsKTc.js"])))=>i.map(i=>d[i]);
import{q as A,c as U,d as B,w as D,e as p,g as k,y as F,a as O,i as T,h as M,u as z,l as w,z as J,_ as g}from"./index-JTWqLALI.js";async function K(e){const t=T(B,"users",e),r=await M(t);return r.exists()?r.data():null}async function N({name:e,phone:t,address:r}){var n;const u=(n=p.currentUser)==null?void 0:n.uid;if(!u)throw new Error("Not logged in");const s=T(B,"users",u);await z(s,{name:e,phone:t,address:r})}async function S(e){if(!p.currentUser)throw new Error("User not authenticated");return await updatePassword(p.currentUser,e)}async function V(){const e=document.getElementById("orderHistoryGrid");if(e){e.textContent="Loading orders...";try{const u=(await F(O,"getUserOrders")()).data.orders;if(e.textContent="",u.length===0){e.textContent="No orders found.";return}u.forEach(s=>{var h,y;const n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow";const l=(h=s.purchasedAt)!=null&&h.toDate?s.purchasedAt.toDate().toLocaleDateString():"",o=s.invoiceId||s.id,f=((y=s.total)==null?void 0:y.toFixed(2))||"0.00",d=document.createElement("div");d.innerHTML=`
        <p class="text-white font-semibold">Invoice #${o}</p>
        <p class="text-sm text-gray-400">Date: ${l}</p>
        <p class="text-sm text-gray-400">Total: $${f}</p>
      `;const m=document.createElement("button");m.className="bg-[#407471] text-white px-4 py-2 rounded text-sm",m.textContent="Download Invoice",m.addEventListener("click",()=>downloadInvoice(o));const i=document.createElement("div");i.className="flex justify-between items-center",i.append(d,m),n.appendChild(i),e.appendChild(n)})}catch(t){console.error("Error loading user orders:",t),e.textContent="Failed to load orders."}}}window.downloadInvoice=async function(e){const t=F(O,"generateOrderPDF");try{const r=await t({invoiceId:e});window.open(r.data.url,"_blank")}catch(r){console.error("PDF download failed:",r),w("Failed to generate invoice.","error")}};async function j(){const e=document.getElementById("myCoursesGrid");if(e){e.textContent="Loading your courses...";try{const t=A(U(B,"courses"),D("purchasedBy","array-contains",p.currentUser.uid)),r=await k(t);if(e.textContent="",r.empty){e.textContent="No courses found.";return}r.forEach(u=>{const s=u.data(),n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow";const l=document.createElement("h4");l.className="text-white font-semibold",l.textContent=s.name;const o=document.createElement("p");o.className="text-sm text-gray-400",o.textContent=s.description,n.append(l,o),e.appendChild(n)})}catch(t){console.error("Error loading courses:",t),e.textContent="Failed to load courses."}}}async function q(){const e=document.getElementById("myWorkshopsGrid");if(e){e.textContent="Loading your workshops...";try{const t=A(U(B,"workshops"),D("purchasedBy","array-contains",p.currentUser.uid)),r=await k(t);if(e.textContent="",r.empty){e.textContent="No workshops found.";return}r.forEach(u=>{const s=u.data(),n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow";const l=document.createElement("h4");l.className="text-white font-semibold",l.textContent=s.name;const o=document.createElement("p");o.className="text-sm text-gray-400",o.textContent=s.description,n.append(l,o),e.appendChild(n)})}catch(t){console.error("Error loading workshops:",t),e.textContent="Failed to load workshops."}}}async function $(){const e=document.getElementById("myPrograms");if(e){e.textContent="Loading your programs...";try{const t=A(U(B,"programs"),D("assignedTo","==",p.currentUser.uid)),r=await k(t);if(e.textContent="",r.empty){e.textContent="No programs found.";return}r.forEach(u=>{const s=u.data(),n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow mb-4";const l=document.createElement("h4");l.className="text-white font-semibold",l.textContent=s.name;const o=document.createElement("p");o.className="text-sm text-gray-400",o.textContent=s.description,n.append(l,o),e.appendChild(n)})}catch(t){console.error("Error loading programs:",t),e.textContent="Failed to load programs."}}}const Q=Object.freeze(Object.defineProperty({__proto__:null,changeUserPassword:S,getUserProfile:K,loadMyPrograms:$,loadOrderReceipts:V,loadProfileCourses:j,loadProfileWorkshops:q,updateUserProfile:N},Symbol.toStringTag,{value:"Module"}));async function ee(){var s,n,l,o,f,d,m;const e=p.currentUser,t=document.getElementById("profileSection"),r="https://firebasestorage.googleapis.com/v0/b/recovery-tools.firebasestorage.app/o/videos%2FImages%2FProfile.png?alt=media&token=261b1542-dc99-44ce-9089-6342e0ee6db9";if(!e){t==null||t.classList.remove("hidden"),t.innerHTML=`
      <div class="max-w-2xl mx-auto text-center mt-12">
        <h2 class="text-xl font-semibold text-white mb-4">Please log in to view your profile.</h2>
        <button id="loginPromptBtn" class="bg-[#407471] text-white px-4 py-2 rounded">Login</button>
      </div>
    `,(s=document.getElementById("loginPromptBtn"))==null||s.addEventListener("click",()=>{J("login")});return}try{const h=await F(O,"getUserRoleWithPermissions")(),{roles:y={}}=h.data||{};y.admin&&((n=document.getElementById("adminAccessLink"))==null||n.classList.remove("hidden")),y.therapist&&((l=document.getElementById("therapistAccessLink"))==null||l.classList.remove("hidden")),y.affiliate&&((o=document.getElementById("affiliateAccessLink"))==null||o.classList.remove("hidden"),(f=document.getElementById("affiliateAccessBtn"))==null||f.classList.remove("hidden"),(d=document.getElementById("affiliateBadge"))==null||d.classList.remove("hidden"));let E=r,I=!1;try{const c=await getUserProfile(e.uid);c!=null&&c.photoURL&&(E=c.photoURL,I=!0)}catch{console.warn("Could not load profile photo, using fallback.")}document.getElementById("profileAvatar").src=E,document.getElementById("headerAvatar").src=E;const a=document.getElementById("removeAvatarBtn");a&&(I?(a.classList.remove("hidden"),a.onclick=async()=>{if(confirm("Are you sure you want to remove your profile photo?")){a.disabled=!0,a.textContent="Removing...";try{const{deleteObject:c,ref:v,getStorage:_}=await g(async()=>{const{deleteObject:L,ref:x,getStorage:C}=await import("./index-JTWqLALI.js").then(H=>H.F);return{deleteObject:L,ref:x,getStorage:C}},__vite__mapDeps([0,1])),b=_(),P=v(b,`avatars/${e.uid}.jpg`);await c(P).catch(()=>{});const{doc:R,updateDoc:G}=await g(async()=>{const{doc:L,updateDoc:x}=await import("./index-JTWqLALI.js").then(C=>C.E);return{doc:L,updateDoc:x}},__vite__mapDeps([0,1])),W=R((await g(async()=>{const{db:L}=await import("./index-JTWqLALI.js").then(x=>x.G);return{db:L}},__vite__mapDeps([0,1]))).db,"users",e.uid);await G(W,{photoURL:""}),document.getElementById("profileAvatar").src=r,document.getElementById("headerAvatar").src=r,a.classList.add("hidden"),w("âœ… Profile photo removed.","success")}catch(c){console.error("Remove photo error:",c),w("Failed to remove photo.","error")}finally{a.disabled=!1,a.textContent="Remove Photo"}}}):a.classList.add("hidden"))}catch(i){console.error("Error fetching user roles or profile:",i),w("Could not load profile.","error")}document.querySelectorAll(".profile-tab-btn").forEach(i=>{i.addEventListener("click",()=>{const h=i.dataset.profileTab;document.querySelectorAll(".profile-tab-btn").forEach(E=>E.classList.remove("active")),i.classList.add("active"),document.querySelectorAll(".profile-tab-content").forEach(E=>E.classList.add("hidden"));const y=document.getElementById(h);y&&(y.classList.remove("hidden"),X(h))})}),Y();const u=document.getElementById("affiliateSignup");u&&u.addEventListener("click",async()=>{history.pushState({},"","/affiliateSignup");const{initAffiliateSignup:i}=await g(async()=>{const{initAffiliateSignup:h}=await import("./affiliate-signup-D6nWsKTc.js");return{initAffiliateSignup:h}},__vite__mapDeps([2,0,1]));i==null||i()}),window.location.hash==="#profileSection"&&(t==null||t.classList.remove("hidden"),(m=document.querySelector('[data-profile-tab="myProfile"]'))==null||m.click())}function X(e){switch(e){case"myCourses":j();break;case"myWorkshops":q();break;case"orderHistory":V();break;case"myPrograms":$();break}}function Y(){var l;const e=document.getElementById("updateName"),t=document.getElementById("updatePhone"),r=document.getElementById("updateAddress");if((l=p.currentUser)!=null&&l.uid&&e&&t&&r){const o=p.currentUser.uid;g(()=>Promise.resolve().then(()=>Q),void 0).then(async f=>{const d=await f.getUserProfile(o);d&&(e.value=d.name||"",t.value=d.phone||"",r.value=d.address||"")})}const u=document.getElementById("updateProfileForm");u&&u.addEventListener("submit",async o=>{o.preventDefault();const f=document.getElementById("updateName").value.trim(),d=document.getElementById("updatePhone").value.trim(),m=document.getElementById("updateAddress").value.trim();try{await N({name:f,phone:d,address:m}),w("âœ… Profile updated.","success")}catch(i){console.error("Update profile error:",i),w("Failed to update profile.","error")}});const s=document.getElementById("changePasswordForm");s&&s.addEventListener("submit",async o=>{o.preventDefault();const f=document.getElementById("newPassword").value.trim();if(f.length<6){w("Password must be at least 6 characters.","error");return}try{await S(f),w("âœ… Password updated.","success"),s.reset()}catch(d){console.error("Password change error:",d),w("Failed to change password.","error")}});const n=document.getElementById("avatarUpload");if(n){n.addEventListener("change",async f=>{const d=f.target.files[0];if(!d||!p.currentUser)return;const m=(await g(async()=>{const{ref:a}=await import("./index-JTWqLALI.js").then(c=>c.F);return{ref:a}},__vite__mapDeps([0,1]))).ref,i=(await g(async()=>{const{uploadBytes:a}=await import("./index-JTWqLALI.js").then(c=>c.F);return{uploadBytes:a}},__vite__mapDeps([0,1]))).uploadBytes,h=(await g(async()=>{const{getDownloadURL:a}=await import("./index-JTWqLALI.js").then(c=>c.F);return{getDownloadURL:a}},__vite__mapDeps([0,1]))).getDownloadURL,{getStorage:y}=await g(async()=>{const{getStorage:a}=await import("./index-JTWqLALI.js").then(c=>c.F);return{getStorage:a}},__vite__mapDeps([0,1])),E=y(),I=m(E,`avatars/${p.currentUser.uid}.jpg`);try{await i(I,d);const a=await h(I),{doc:c,updateDoc:v}=await g(async()=>{const{doc:b,updateDoc:P}=await import("./index-JTWqLALI.js").then(R=>R.E);return{doc:b,updateDoc:P}},__vite__mapDeps([0,1])),_=c((await g(async()=>{const{db:b}=await import("./index-JTWqLALI.js").then(P=>P.G);return{db:b}},__vite__mapDeps([0,1]))).db,"users",p.currentUser.uid);await v(_,{photoURL:a}),document.getElementById("profileAvatar").src=a,document.getElementById("headerAvatar").src=a,w("âœ… Profile photo updated.","success")}catch(a){console.error("Avatar upload error:",a),w("Failed to upload photo.","error")}});const o=document.getElementById("removeAvatarBtn");o&&o.addEventListener("click",async()=>{if(!p.currentUser||!confirm("Are you sure you want to remove your profile photo?"))return;o.disabled=!0,o.textContent="Removing...";const d="https://firebasestorage.googleapis.com/v0/b/recovery-tools.firebasestorage.app/o/videos%2FImages%2FProfile.png?alt=media&token=261b1542-dc99-44ce-9089-6342e0ee6db9";try{const{getStorage:m,ref:i,deleteObject:h}=await g(async()=>{const{getStorage:v,ref:_,deleteObject:b}=await import("./index-JTWqLALI.js").then(P=>P.F);return{getStorage:v,ref:_,deleteObject:b}},__vite__mapDeps([0,1])),y=m(),E=i(y,`avatars/${p.currentUser.uid}.jpg`);await h(E).catch(v=>{if(v.code!=="storage/object-not-found")throw v});const{doc:I,updateDoc:a}=await g(async()=>{const{doc:v,updateDoc:_}=await import("./index-JTWqLALI.js").then(b=>b.E);return{doc:v,updateDoc:_}},__vite__mapDeps([0,1])),c=I((await g(async()=>{const{db:v}=await import("./index-JTWqLALI.js").then(_=>_.G);return{db:v}},__vite__mapDeps([0,1]))).db,"users",p.currentUser.uid);await a(c,{photoURL:""}),document.getElementById("profileAvatar").src=d,document.getElementById("headerAvatar").src=d,w("ðŸ§¼ Photo removed and reset to default.","success")}catch(m){console.error("Error removing photo:",m),w("Failed to remove photo.","error")}finally{o.disabled=!1,o.textContent="Remove Photo"}})}}export{ee as setupProfilePage};
