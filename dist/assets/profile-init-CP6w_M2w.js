const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.esm-aPO3Hq5E.js","assets/index-C19OQbm5.js","assets/index-BX-zvSAK.css","assets/index.esm-z41brgJC.js"])))=>i.map(i=>d[i]);
import{J as R,t as C,a6 as B,N as U,aa as u,E as A,ae as D,a8 as k,w as F,z as W,M as H,ac as w,af as G,ag as y}from"./index-C19OQbm5.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";async function z(e){const t=F(B,"users",e),r=await W(t);return r.exists()?r.data():null}async function O({name:e,phone:t,address:r}){var n;const l=(n=u.currentUser)==null?void 0:n.uid;if(!l)throw new Error("Not logged in");const s=F(B,"users",l);await H(s,{name:e,phone:t,address:r})}async function T(e){if(!u.currentUser)throw new Error("User not authenticated");return await updatePassword(u.currentUser,e)}async function N(){const e=document.getElementById("orderHistoryGrid");if(e){e.textContent="Loading orders...";try{const l=(await D(k,"getUserOrders")()).data.orders;if(e.textContent="",l.length===0){e.textContent="No orders found.";return}l.forEach(s=>{var h,f;const n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow";const d=(h=s.purchasedAt)!=null&&h.toDate?s.purchasedAt.toDate().toLocaleDateString():"",o=s.invoiceId||s.id,m=((f=s.total)==null?void 0:f.toFixed(2))||"0.00",c=document.createElement("div");c.innerHTML=`
        <p class="text-white font-semibold">Invoice #${o}</p>
        <p class="text-sm text-gray-400">Date: ${d}</p>
        <p class="text-sm text-gray-400">Total: $${m}</p>
      `;const i=document.createElement("button");i.className="bg-[#407471] text-white px-4 py-2 rounded text-sm",i.textContent="Download Invoice",i.addEventListener("click",()=>downloadInvoice(o));const p=document.createElement("div");p.className="flex justify-between items-center",p.append(c,i),n.appendChild(p),e.appendChild(n)})}catch(t){console.error("Error loading user orders:",t),e.textContent="Failed to load orders."}}}window.downloadInvoice=async function(e){const t=D(k,"generateOrderPDF");try{const r=await t({invoiceId:e});window.open(r.data.url,"_blank")}catch(r){console.error("PDF download failed:",r),w("Failed to generate invoice.","error")}};async function V(){const e=document.getElementById("myCoursesGrid");if(e){e.textContent="Loading your courses...";try{const t=R(C(B,"courses"),U("purchasedBy","array-contains",u.currentUser.uid)),r=await A(t);if(e.textContent="",r.empty){e.textContent="No courses found.";return}r.forEach(l=>{const s=l.data(),n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow";const d=document.createElement("h4");d.className="text-white font-semibold",d.textContent=s.name;const o=document.createElement("p");o.className="text-sm text-gray-400",o.textContent=s.description,n.append(d,o),e.appendChild(n)})}catch(t){console.error("Error loading courses:",t),e.textContent="Failed to load courses."}}}async function S(){const e=document.getElementById("myWorkshopsGrid");if(e){e.textContent="Loading your workshops...";try{const t=R(C(B,"workshops"),U("purchasedBy","array-contains",u.currentUser.uid)),r=await A(t);if(e.textContent="",r.empty){e.textContent="No workshops found.";return}r.forEach(l=>{const s=l.data(),n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow";const d=document.createElement("h4");d.className="text-white font-semibold",d.textContent=s.name;const o=document.createElement("p");o.className="text-sm text-gray-400",o.textContent=s.description,n.append(d,o),e.appendChild(n)})}catch(t){console.error("Error loading workshops:",t),e.textContent="Failed to load workshops."}}}async function j(){const e=document.getElementById("myPrograms");if(e){e.textContent="Loading your programs...";try{const t=R(C(B,"programs"),U("assignedTo","==",u.currentUser.uid)),r=await A(t);if(e.textContent="",r.empty){e.textContent="No programs found.";return}r.forEach(l=>{const s=l.data(),n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow mb-4";const d=document.createElement("h4");d.className="text-white font-semibold",d.textContent=s.name;const o=document.createElement("p");o.className="text-sm text-gray-400",o.textContent=s.description,n.append(d,o),e.appendChild(n)})}catch(t){console.error("Error loading programs:",t),e.textContent="Failed to load programs."}}}const J=Object.freeze(Object.defineProperty({__proto__:null,changeUserPassword:T,getUserProfile:z,loadMyPrograms:j,loadOrderReceipts:N,loadProfileCourses:V,loadProfileWorkshops:S,updateUserProfile:O},Symbol.toStringTag,{value:"Module"}));async function re(){var l,s,n,d,o,m,c;const e=u.currentUser,t=document.getElementById("profileSection"),r="https://firebasestorage.googleapis.com/v0/b/recovery-tools.firebasestorage.app/o/videos%2FImages%2FProfile.png?alt=media&token=261b1542-dc99-44ce-9089-6342e0ee6db9";if(!e){t==null||t.classList.remove("hidden"),t.innerHTML=`
      <div class="max-w-2xl mx-auto text-center mt-12">
        <h2 class="text-xl font-semibold text-white mb-4">Please log in to view your profile.</h2>
        <button id="loginPromptBtn" class="bg-[#407471] text-white px-4 py-2 rounded">Login</button>
      </div>
    `,(l=document.getElementById("loginPromptBtn"))==null||l.addEventListener("click",()=>{G("login")});return}try{const p=await D(k,"getUserRoleWithPermissions")(),{roles:h={}}=p.data||{};h.admin&&((s=document.getElementById("adminAccessLink"))==null||s.classList.remove("hidden")),h.therapist&&((n=document.getElementById("therapistAccessLink"))==null||n.classList.remove("hidden")),h.affiliate&&((d=document.getElementById("affiliateAccessLink"))==null||d.classList.remove("hidden"),(o=document.getElementById("affiliateAccessBtn"))==null||o.classList.remove("hidden"),(m=document.getElementById("affiliateBadge"))==null||m.classList.remove("hidden"));let f=r,b=!1;try{const a=await getUserProfile(e.uid);a!=null&&a.photoURL&&(f=a.photoURL,b=!0)}catch{console.warn("Could not load profile photo, using fallback.")}document.getElementById("profileAvatar").src=f,document.getElementById("headerAvatar").src=f;const g=document.getElementById("removeAvatarBtn");g&&(b?(g.classList.remove("hidden"),g.onclick=async()=>{if(confirm("Are you sure you want to remove your profile photo?")){g.disabled=!0,g.textContent="Removing...";try{const{deleteObject:a,ref:P,getStorage:v}=await y(async()=>{const{deleteObject:x,ref:L,getStorage:M}=await import("./index.esm-aPO3Hq5E.js");return{deleteObject:x,ref:L,getStorage:M}},__vite__mapDeps([0,1,2])),E=v(),_=P(E,`avatars/${e.uid}.jpg`);await a(_).catch(()=>{});const{doc:I,updateDoc:q}=await y(async()=>{const{doc:x,updateDoc:L}=await import("./index.esm-z41brgJC.js");return{doc:x,updateDoc:L}},__vite__mapDeps([3,1,2])),$=I((await y(async()=>{const{db:x}=await import("./index-C19OQbm5.js").then(L=>L.ak);return{db:x}},__vite__mapDeps([1,2]))).db,"users",e.uid);await q($,{photoURL:""}),document.getElementById("profileAvatar").src=r,document.getElementById("headerAvatar").src=r,g.classList.add("hidden"),w("âœ… Profile photo removed.","success")}catch(a){console.error("Remove photo error:",a),w("Failed to remove photo.","error")}finally{g.disabled=!1,g.textContent="Remove Photo"}}}):g.classList.add("hidden"))}catch(i){console.error("Error fetching user roles or profile:",i),w("Could not load profile.","error")}document.querySelectorAll(".profile-tab-btn").forEach(i=>{i.addEventListener("click",()=>{const p=i.dataset.profileTab;document.querySelectorAll(".profile-tab-btn").forEach(f=>f.classList.remove("active")),i.classList.add("active"),document.querySelectorAll(".profile-tab-content").forEach(f=>f.classList.add("hidden"));const h=document.getElementById(p);h&&(h.classList.remove("hidden"),K(p))})}),Q(),window.location.hash==="#profileSection"&&(t==null||t.classList.remove("hidden"),(c=document.querySelector('[data-profile-tab="myProfile"]'))==null||c.click())}function K(e){switch(e){case"myCourses":V();break;case"myWorkshops":S();break;case"orderHistory":N();break;case"myPrograms":j();break}}function Q(){var d;const e=document.getElementById("updateName"),t=document.getElementById("updatePhone"),r=document.getElementById("updateAddress");if((d=u.currentUser)!=null&&d.uid&&e&&t&&r){const o=u.currentUser.uid;y(()=>Promise.resolve().then(()=>J),void 0).then(async m=>{const c=await m.getUserProfile(o);c&&(e.value=c.name||"",t.value=c.phone||"",r.value=c.address||"")})}const l=document.getElementById("updateProfileForm");l&&l.addEventListener("submit",async o=>{o.preventDefault();const m=document.getElementById("updateName").value.trim(),c=document.getElementById("updatePhone").value.trim(),i=document.getElementById("updateAddress").value.trim();try{await O({name:m,phone:c,address:i}),w("âœ… Profile updated.","success")}catch(p){console.error("Update profile error:",p),w("Failed to update profile.","error")}});const s=document.getElementById("changePasswordForm");s&&s.addEventListener("submit",async o=>{o.preventDefault();const m=document.getElementById("newPassword").value.trim();if(m.length<6){w("Password must be at least 6 characters.","error");return}try{await T(m),w("âœ… Password updated.","success"),s.reset()}catch(c){console.error("Password change error:",c),w("Failed to change password.","error")}});const n=document.getElementById("avatarUpload");if(n){n.addEventListener("change",async m=>{const c=m.target.files[0];if(!c||!u.currentUser)return;const i=(await y(async()=>{const{ref:a}=await import("./index.esm-aPO3Hq5E.js");return{ref:a}},__vite__mapDeps([0,1,2]))).ref,p=(await y(async()=>{const{uploadBytes:a}=await import("./index.esm-aPO3Hq5E.js");return{uploadBytes:a}},__vite__mapDeps([0,1,2]))).uploadBytes,h=(await y(async()=>{const{getDownloadURL:a}=await import("./index.esm-aPO3Hq5E.js");return{getDownloadURL:a}},__vite__mapDeps([0,1,2]))).getDownloadURL,{getStorage:f}=await y(async()=>{const{getStorage:a}=await import("./index.esm-aPO3Hq5E.js");return{getStorage:a}},__vite__mapDeps([0,1,2])),b=f(),g=i(b,`avatars/${u.currentUser.uid}.jpg`);try{await p(g,c);const a=await h(g),{doc:P,updateDoc:v}=await y(async()=>{const{doc:_,updateDoc:I}=await import("./index.esm-z41brgJC.js");return{doc:_,updateDoc:I}},__vite__mapDeps([3,1,2])),E=P((await y(async()=>{const{db:_}=await import("./index-C19OQbm5.js").then(I=>I.ak);return{db:_}},__vite__mapDeps([1,2]))).db,"users",u.currentUser.uid);await v(E,{photoURL:a}),document.getElementById("profileAvatar").src=a,document.getElementById("headerAvatar").src=a,w("âœ… Profile photo updated.","success")}catch(a){console.error("Avatar upload error:",a),w("Failed to upload photo.","error")}});const o=document.getElementById("removeAvatarBtn");o&&o.addEventListener("click",async()=>{if(!u.currentUser||!confirm("Are you sure you want to remove your profile photo?"))return;o.disabled=!0,o.textContent="Removing...";const c="https://firebasestorage.googleapis.com/v0/b/recovery-tools.firebasestorage.app/o/videos%2FImages%2FProfile.png?alt=media&token=261b1542-dc99-44ce-9089-6342e0ee6db9";try{const{getStorage:i,ref:p,deleteObject:h}=await y(async()=>{const{getStorage:v,ref:E,deleteObject:_}=await import("./index.esm-aPO3Hq5E.js");return{getStorage:v,ref:E,deleteObject:_}},__vite__mapDeps([0,1,2])),f=i(),b=p(f,`avatars/${u.currentUser.uid}.jpg`);await h(b).catch(v=>{if(v.code!=="storage/object-not-found")throw v});const{doc:g,updateDoc:a}=await y(async()=>{const{doc:v,updateDoc:E}=await import("./index.esm-z41brgJC.js");return{doc:v,updateDoc:E}},__vite__mapDeps([3,1,2])),P=g((await y(async()=>{const{db:v}=await import("./index-C19OQbm5.js").then(E=>E.ak);return{db:v}},__vite__mapDeps([1,2]))).db,"users",u.currentUser.uid);await a(P,{photoURL:""}),document.getElementById("profileAvatar").src=c,document.getElementById("headerAvatar").src=c,w("ðŸ§¼ Photo removed and reset to default.","success")}catch(i){console.error("Error removing photo:",i),w("Failed to remove photo.","error")}finally{o.disabled=!1,o.textContent="Remove Photo"}})}}export{re as setupProfilePage};
