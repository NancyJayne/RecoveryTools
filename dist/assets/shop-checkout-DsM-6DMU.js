import{f as l,a as le,b as he,e as de,h as ge,i as ce,d as oe,j as be,k as ye,l as re}from"./index-JTWqLALI.js";import{confirmOrderFromStripeRedirect as xe}from"./shop-orders-BiCYvovt.js";let E=de.currentUser;async function ke(){const me=new URLSearchParams(window.location.search).get("success")==="true",o=document.getElementById("checkoutSummary"),h=document.getElementById("checkoutBtn");if(!o)return;if(me){xe().then(e=>{var j,G,R,W,Y,J,Q,V,z,K,X,Z,ee,te,ne,se;const s=e.products.some(a=>a.type==="course"),t=document.createElement("div");t.className="text-center py-12 px-4 sm:px-6 lg:px-8";const i=document.createElement("div");i.className="text-5xl mb-4 text-green-400",i.textContent="üéâ";const n=document.createElement("h2");n.className="text-3xl font-bold text-white mb-2",n.textContent="Your order is confirmed!";const c=document.createElement("p");c.className="text-gray-300 mb-1",c.textContent="Thanks! A receipt has been emailed.";const N=document.createElement("p");N.className="text-gray-400 text-sm",N.innerHTML=`Order ID: <strong>${(e==null?void 0:e.invoiceId)||"N/A"}</strong>`;const d=document.createElement("a");d.href="/shop",d.className="mt-6 inline-block bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded",d.textContent="Continue Shopping",t.append(i,n,c,N,d),o.innerHTML="",o.appendChild(t);const f=document.createElement("div");f.className="bg-gray-900 p-6 mt-8 rounded-lg shadow text-white text-left max-w-xl mx-auto";const M=document.createElement("h3");M.className="text-xl font-bold mb-4",M.textContent="Order Summary",f.appendChild(M),e.products.forEach(a=>{var ie;const C=document.createElement("div");C.className="flex justify-between border-b border-gray-700 py-2 text-sm";const S=document.createElement("div"),g=document.createElement("div");g.className="font-semibold",g.textContent=a.name;const D=document.createElement("div");D.className="text-gray-400",D.textContent=`${((ie=a.type)==null?void 0:ie.toUpperCase())||"ITEM"} x${a.quantity}`,S.append(g,D);const ae=document.createElement("div");ae.textContent=l(a.price*a.quantity/100),C.append(S,ae),f.appendChild(C)}),[{label:"Subtotal",value:l(e.subtotal/100)},{label:"Shipping",value:l((((j=e.shipping)==null?void 0:j.amount_total)||1e3)/100)},{label:"GST",value:l(e.total/11)},{label:"Total",value:l(e.total/100),bold:!0}].forEach(({label:a,value:C,bold:S})=>{const g=document.createElement("div");g.className=`text-right text-sm text-gray-400 mt-1${S?" text-lg font-bold text-white":""}`,g.textContent=`${a}: ${C}`,f.appendChild(g)}),o.appendChild(f),le.httpsCallable("sendTransactionalEmail")({to:e.userEmail,templateId:"d-4b0e5696c6a14a67892e586f385b6e7d",dynamicTemplateData:{first_name:((G=e==null?void 0:e.userName)==null?void 0:G.split(" ")[0])||"Customer",order_id:e==null?void 0:e.invoiceId,order_items:e.products.map(a=>({name:a.name,quantity:a.quantity,type:a.type||"Item",price:l(a.price/100),accessUrl:a.type==="course"?`https://recoverytools.au/courses/${a.productId}`:null})),total:l(e.total/100),shipping_cost:l((((R=e.shipping)==null?void 0:R.amount_total)||1e3)/100),shipping_name:((W=e.shipping)==null?void 0:W.name)||e.userName||"",shipping_address:{line1:((J=(Y=e.shipping)==null?void 0:Y.address)==null?void 0:J.line1)||"",line2:((V=(Q=e.shipping)==null?void 0:Q.address)==null?void 0:V.line2)||"",city:((K=(z=e.shipping)==null?void 0:z.address)==null?void 0:K.city)||"",state:((Z=(X=e.shipping)==null?void 0:X.address)==null?void 0:Z.state)||"",postcode:((te=(ee=e.shipping)==null?void 0:ee.address)==null?void 0:te.postal_code)||"",country:((se=(ne=e.shipping)==null?void 0:ne.address)==null?void 0:se.country)||"AU"},invoice_url:e.invoiceUrl||"https://recoverytools.au/profile",unsubscribe_url:"https://recoverytools.au/unsubscribe",show_course_button:s,course_button_url:s?"https://recoverytools.au/courses":""}})}).catch(()=>{o.innerHTML="<p class='text-red-500'>‚ö† Something went wrong confirming your order.</p>"});return}if(!h)return;const v=he();if(!v.length){o.innerHTML="<p class='text-red-500'>Your cart is empty.</p>",h.disabled=!0;return}o.innerHTML="";const r=document.createElement("form");r.className="space-y-4",o.appendChild(r),E=de.currentUser;let y={};if(E){const e=await ge(ce(oe,"users",E.uid));y=e.exists()?e.data().checkoutProfile||{}:{}}const $=document.createElement("div");$.className="grid grid-cols-1 md:grid-cols-2 gap-4";const F=document.createElement("div"),w=document.createElement("label");w.htmlFor="name",w.className="block text-sm font-medium text-white",w.textContent="Full Name";const m=document.createElement("input");m.type="text",m.name="name",m.id="name",m.autocomplete="name",m.required=!0,m.className="mt-1 block w-full bg-gray-800 border border-gray-700 text-white rounded-md px-3 py-2",m.value=y.name||"",F.append(w,m);const P=document.createElement("div"),k=document.createElement("label");k.htmlFor="email",k.className="block text-sm font-medium text-white",k.textContent="Email";const p=document.createElement("input");p.type="email",p.name="email",p.id="email",p.autocomplete="email",p.required=!0,p.className="mt-1 block w-full bg-gray-800 border border-gray-700 text-white rounded-md px-3 py-2",p.value=y.email||"",P.append(k,p),$.append(F,P),r.appendChild($);const L=document.createElement("div");L.className="grid grid-cols-1 md:grid-cols-2 gap-4";const U=[{id:"shippingAddress_line1",label:"Address Line 1",required:!0},{id:"shippingAddress_line2",label:"Address Line 2"},{id:"shippingAddress_city",label:"City",required:!0},{id:"shippingAddress_state",label:"State",required:!0},{id:"shippingAddress_postcode",label:"Postcode",required:!0},{id:"shippingAddress_country",label:"Country",required:!0,defaultValue:"Australia"}];U.forEach(({id:e,label:s,required:t,defaultValue:i})=>{const n=document.createElement("div");n.innerHTML=`
      <label for="${e}" class="block text-sm font-medium text-white">${s}</label>
      <input type="text" name="${e}" id="${e}" ${t?"required":""}
        class="mt-1 block w-full bg-gray-800 border border-gray-700 text-white rounded-md px-3 py-2"
        value="${y[e]||i||""}" />
    `,L.appendChild(n)}),r.appendChild(L);const T=document.createElement("div");T.className="mt-6",T.innerHTML=`
    <label class="inline-flex items-center text-white">
      <input type="checkbox" id="sameAsShipping" class="form-checkbox bg-gray-800 border-gray-700 text-green-500" checked />
      <span class="ml-2">Billing address same as shipping</span>
    </label>
  `,r.appendChild(T);const b=document.createElement("div");b.id="billingAddressContainer",b.className="mt-6 hidden";const q=document.createElement("h4");q.className="text-white",q.textContent="Billing Address",b.appendChild(q);const A=document.createElement("div");A.className="grid grid-cols-1 md:grid-cols-2 gap-4",U.forEach(({id:e,label:s,required:t,defaultValue:i})=>{const n=e.replace("shippingAddress","billingAddress"),c=document.createElement("div");c.innerHTML=`
      <label for="${n}" class="block text-sm font-medium text-white">${s}</label>
      <input type="text" name="${n}" id="${n}" ${t?"required":""}
        class="mt-1 block w-full bg-gray-800 border border-gray-700 text-white rounded-md px-3 py-2"
        value="${y[n]||i||""}" />
    `,A.appendChild(c)}),b.appendChild(A),r.appendChild(b);const I=r.querySelector("#sameAsShipping");I==null||I.addEventListener("change",e=>{const s=e.target.checked;b.classList.toggle("hidden",s),A.querySelectorAll("input").forEach(t=>{t.disabled=s})});const x=(e,s)=>{const t=document.createElement("div");t.className="flex justify-between border-b border-gray-700 py-2 text-sm";const i=document.createElement("div"),n=document.createElement("div");n.className="font-semibold",n.textContent=e,i.appendChild(n);const c=document.createElement("div");return c.textContent=s,t.append(i,c),t},u=document.createElement("div");u.className="bg-gray-900 p-6 mt-8 rounded-lg shadow text-white text-left max-w-xl mx-auto";const H=document.createElement("h3");H.className="text-xl font-bold mb-4",H.textContent="Order Summary",u.appendChild(H);let _=0;v.forEach(e=>{var n;const s=e.price*e.quantity/100;_+=s;const t=`${((n=e.type)==null?void 0:n.toUpperCase())||"ITEM"} x${e.quantity}`,i=`${e.name} (${t})`;u.appendChild(x(i,l(s)))});const B=1e3,pe=_/11,ue=_+B;u.appendChild(x("Subtotal",l(_))),u.appendChild(x("Shipping",l(B))),u.appendChild(x("GST",l(pe)));const O=x("Total",l(ue));O.classList.add("text-lg","font-bold","text-white"),u.appendChild(O),o.appendChild(u),h.addEventListener("click",async e=>{var i;e.preventDefault(),h.disabled=!0,h.textContent="Processing...";const s=new FormData(r),t=Object.fromEntries(s.entries());if((i=r.querySelector("#sameAsShipping"))!=null&&i.checked?t.billingAddress={line1:t.shippingAddress_line1,line2:t.shippingAddress_line2,city:t.shippingAddress_city,state:t.shippingAddress_state,postcode:t.shippingAddress_postcode,country:t.shippingAddress_country}:t.billingAddress={line1:t.billingAddress_line1,line2:t.billingAddress_line2,city:t.billingAddress_city,state:t.billingAddress_state,postcode:t.billingAddress_postcode,country:t.billingAddress_country},E)try{await be(ce(oe,"users",E.uid),{checkoutProfile:t},{merge:!0})}catch(n){console.warn("‚ö† Failed to save checkout profile:",n)}try{const n=await ye("checkout"),d=(await le.httpsCallable("createCheckoutSession")({cart:v,referrerId:localStorage.getItem("referrer_uid")||null,collectShipping:!0,customerInfo:t,token:n})).data;d!=null&&d.id?(sessionStorage.setItem("cartBackup",JSON.stringify(v)),window.location.href=`https://checkout.stripe.com/c/pay/${d.id}`):re("Failed to initiate checkout session.","error")}catch(n){console.error("‚ùå Stripe Checkout error:",n),re("Unable to start checkout.","error"),h.disabled=!1,h.textContent="Checkout"}})}export{ke as setupCheckoutPage};
