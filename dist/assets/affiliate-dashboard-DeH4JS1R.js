import{ae as L,a8 as C,z as H,w as b,a6 as y,aa as E,ac as d,s as D,t as k,E as W,J as S,N as B,I as G,v as T,K as P,T as R,M as V}from"./index-5KMkTDqe.js";import{a as q,d as _,c as J,b as K}from"./date-utils-B0NO50wt.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";const Q=L(C,"getAffiliatePayouts");async function X(){try{return(await Q()).data.payouts||[]}catch(e){return console.error("Failed to load payouts:",e),[]}}async function Z(){const e=L(C,"createStripeConnectLink");try{return(await e()).data.url}catch(t){return console.error("Stripe connect error:",t),null}}async function ee(){const e=L(C,"createStripeLoginLink");try{return(await e()).data.url}catch(t){return console.error("Stripe login error:",t),null}}async function te(){var r,s;const e=document.getElementById("connectStripeBtn"),t=document.getElementById("manageStripeBtn");try{((r=(await H(b(y,"users",E.currentUser.uid))).data())==null?void 0:r.stripeAccountId)?(e==null||e.classList.add("hidden"),(s=document.getElementById("stripeConnectedMsg"))==null||s.classList.remove("hidden"),t==null||t.classList.remove("hidden"),t==null||t.addEventListener("click",async()=>{try{const n=await ee();n&&(window.location.href=n)}catch(n){console.error("Login link error:",n),d("Unable to open Stripe dashboard.","error")}})):e==null||e.addEventListener("click",async()=>{try{const n=await Z();n&&(window.location.href=n)}catch(n){console.error("Stripe Connect Error:",n),d("Could not initiate onboarding.","error")}})}catch(o){console.error("Error checking Stripe status:",o),d("Error loading Stripe settings.","error")}}function w(e){return e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)+/g,"")}function oe(e){return/^[a-z0-9-]+$/.test(e)}function ne(e=[]){if(!Array.isArray(e)||e.length===0)return;const t=["Amount","Date","Stripe Payout ID"],r=e.map(i=>[i.amount||0,q(i.createdAt),i.stripePayoutId||""]),s=[t,...r].map(i=>i.join(",")).join(`
`),o=new Blob([s],{type:"text/csv"}),a=URL.createObjectURL(o),n=document.createElement("a");n.href=a,n.download="affiliate_payouts.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function re(e){var t;try{const r=(t=E.currentUser)==null?void 0:t.uid;if(!r)throw new Error("User not authenticated");await D(k(y,"courses"),{...e,creatorId:r,createdAt:new Date,type:"Course"}),d("âœ… Course proposal submitted","success")}catch(r){console.error("Submit course error:",r),d("Failed to submit course proposal.","error")}}async function N(){const e=E.currentUser;if(!e)return;const t=document.getElementById("mySubmittedCourses");if(t){t.innerHTML=`
    <div class="flex justify-center items-center min-h-[100px]">
      <div class="w-8 h-8 border-4 border-t-transparent border-green-400 rounded-full animate-spin"></div>
    </div>
  `;try{const s=(await W(S(k(y,"courses"),B("createdBy","==",e.uid),G("createdAt","desc")))).docs.map(o=>({id:o.id,...o.data()}));if(t.innerHTML="",s.length===0){t.innerHTML='<p class="text-gray-400">No courses submitted yet.</p>';return}s.forEach(o=>{const a=document.createElement("div");a.className="bg-gray-800 text-white rounded-lg shadow p-4";const n=document.createElement("img");n.src=o.image||"https://via.placeholder.com/600x400?text=Course",n.alt=`${o.title||"Course"} thumbnail`,n.className="w-full h-32 object-cover rounded mb-3";const i=document.createElement("h3");i.className="text-lg font-semibold",i.textContent=o.title||"Untitled Course";const c=document.createElement("p");c.className=`text-sm ${o.status==="approved"?"text-green-400":"text-yellow-400"}`,c.textContent=`Status: ${o.status||"pending"}`;const u=document.createElement("p");u.className="text-sm text-gray-400",u.textContent=o.shortDescription||(o.description||"").slice(0,80)+"...";const l=o.duration?document.createElement("p"):null;l&&(l.className="text-xs text-gray-500",l.textContent=`ðŸ•’ Duration: ${o.duration}`);const m=document.createElement("div");m.className="flex flex-wrap gap-2 mt-4";const p=document.createElement("button");p.className="edit-course-btn bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 text-sm",p.textContent="Edit",p.addEventListener("click",async()=>{const f=await H(b(y,"courses",o.id));f.exists()?se({id:f.id,...f.data()}):d("Course not found.","error")});const g=document.createElement("button");g.className="delete-course-btn bg-red-600 px-3 py-1 rounded hover:bg-red-700 text-sm",g.textContent="Delete",g.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete this course?"))try{await T(b(y,"courses",o.id)),d("Course deleted.","success"),N()}catch(v){console.error("Delete failed:",v),d("Failed to delete course.","error")}});const h=document.createElement("button");h.className="copy-course-link-btn bg-green-600 px-3 py-1 rounded hover:bg-green-700 text-sm",h.textContent="Copy Referral Link",h.addEventListener("click",()=>{ae(o.id)}),m.append(p,g,h),a.append(n,i,c,u),l&&a.appendChild(l),a.appendChild(m),t.appendChild(a)})}catch(r){console.error("Error loading courses:",r),d("Failed to load your courses.","error")}}}function se(e){document.getElementById("editCourseId").value=e.id,[["editCourseTitle",e.title],["editCourseDescription",e.description],["editCourseShortDescription",e.shortDescription],["editCourseSlug",e.slug],["editCourseDuration",e.duration],["editCoursePrice",e.price],["editCourseSalePrice",e.salePrice]].forEach(([l,m])=>{const p=document.getElementById(l);p&&(p.value=m||"",p.dataset.original=m||"")});const r=document.getElementById("editCourseFeatures");if(r){const l=Array.isArray(e.features)?e.features.join(", "):"";r.value=l,r.dataset.original=l}const s=document.getElementById("editCourseMaxParticipants");s&&(s.value=e.maxParticipants??"",s.dataset.original=e.maxParticipants??"");const o=document.getElementById("editCourseTags");if(o){const l=Array.isArray(e.tags)?e.tags.join(", "):"";o.value=l,o.dataset.original=l}const a=document.getElementById("editCourseVisible");a&&(a.checked=e.visible??!0,a.dataset.original=String(e.visible??!0));const n=document.getElementById("editCourseOnSale");n&&(n.checked=!!e.onSale,n.dataset.original=String(!!e.onSale));const i=document.getElementById("editCourseImagePreview");i&&e.image&&(i.src=e.image);const c=document.getElementById("editCourseImage");c&&(c.value="");const u=document.getElementById("editCourseModal");u.classList.remove("hidden","opacity-0"),u.classList.add("opacity-100","transition-opacity","duration-300")}function ae(e){const t=E.currentUser;if(!t){d("Please login to generate your referral link.","error");return}const s=`${`${window.location.origin}/courses`}?ref=${t.uid}&course=${e}`;navigator.clipboard.writeText(s).then(()=>d("Your referral link has been copied!","success")).catch(()=>d("Failed to copy link.","error"))}function ie(){N()}function de(){const e=document.getElementById("courseProposalForm");e&&e.addEventListener("submit",async t=>{var s,o,a,n,i,c;t.preventDefault();const r={title:(o=(s=e.title)==null?void 0:s.value)==null?void 0:o.trim(),description:(n=(a=e.description)==null?void 0:a.value)==null?void 0:n.trim(),price:parseFloat((c=(i=e.price)==null?void 0:i.value)==null?void 0:c.trim())};if(!r.title||!r.description||isNaN(r.price)){d("Please fill in all required fields correctly.","error");return}await re(r),e.reset(),N()})}async function F(){const e=document.getElementById("submittedWorkshops");e.innerHTML="<p class='text-gray-400'>Loading...</p>";try{const t=S(k(y,"products"),B("type","==","Workshop"),B("creatorId","==",E.currentUser.uid),orderBy("createdAt","desc")),r=await W(t);if(r.empty){e.innerHTML="<p class='text-gray-400'>No workshops submitted yet.</p>";return}e.innerHTML="",r.forEach(s=>{const o=s.data(),a=s.id,n=K(o.dateUTC,o.timezone),i=document.createElement("div");i.className="p-4 border border-gray-700 rounded mb-4",i.innerHTML=`
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-white font-semibold text-lg">${o.title}</h3>
            <p class="text-sm text-gray-400">${n} (${o.timezone})</p>
            <p class="text-sm text-gray-500">${o.location||"No location"}</p>
          </div>
          <div class="flex gap-2">
            <button
  class="editWorkshopBtn bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded"
  data-id="${a}"
>
  Edit
</button>

<button
  class="deleteWorkshopBtn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded"
  data-id="${a}"
>
  Delete
</button>
          </div>
        </div>
      `,e.appendChild(i)}),e.querySelectorAll(".editWorkshopBtn").forEach(s=>{s.addEventListener("click",()=>Y(s.dataset.id))}),e.querySelectorAll(".deleteWorkshopBtn").forEach(s=>{s.addEventListener("click",()=>z(s.dataset.id))})}catch(t){console.error("Error loading workshops:",t),e.innerHTML="<p class='text-red-500'>Failed to load workshops.</p>"}}async function ce(){const e=document.getElementById("workshopForm");if(!e)return;const t=e.querySelector("#workshopTimezone");t&&(t.value=_()),e.addEventListener("submit",async r=>{r.preventDefault();const s=new FormData(e),o=s.get("title").trim(),a=s.get("date").trim(),n=s.get("timezone"),i=s.get("location").trim(),c=J(a,n),u={title:o,location:i,dateLocal:a,dateUTC:c,timezone:n,createdBy:E.currentUser.uid,createdAt:P(),visible:!1};await D(k(y,"products"),u),d("Workshop submitted for review.","success"),e.reset(),document.getElementById("addWorkshopModal").classList.add("hidden"),F()})}async function z(e){if(confirm("Are you sure you want to delete this workshop?"))try{await T(b(y,"products",e)),d("Workshop deleted successfully.","success"),F(),document.getElementById("editWorkshopModal").classList.add("hidden")}catch(t){console.error("Failed to delete workshop:",t),d("Failed to delete workshop.","error")}}var A;(A=document.getElementById("submitWorkshopForm"))==null||A.addEventListener("submit",le);var M;(M=document.getElementById("cancelEditWorkshopBtn"))==null||M.addEventListener("click",$);var U;(U=document.getElementById("saveEditWorkshopBtn"))==null||U.addEventListener("click",e=>{e.preventDefault(),ue()});var j;(j=document.getElementById("deleteEditWorkshopBtn"))==null||j.addEventListener("click",async()=>{var r;if(!confirm("Are you sure you want to delete this workshop?"))return;const t=(r=document.getElementById("editWorkshopId"))==null?void 0:r.value;if(t)try{await T(b(y,"workshops",t)),d("Workshop deleted successfully","success"),$(),I()}catch(s){console.error("Failed to delete workshop:",s),d("Error deleting workshop","error")}});async function le(e){var l;e.preventDefault();const t=E.currentUser;if(!t){d("Please log in first.","error");return}const r=document.getElementById("workshopName").value.trim(),s=document.getElementById("workshopLocation").value.trim(),o=document.getElementById("workshopDate").value,a=parseInt(document.getElementById("workshopPrice").value.trim(),10),n=document.getElementById("workshopDescription").value.trim(),i=parseInt(((l=document.getElementById("workshopStock"))==null?void 0:l.value)||"0",10)||null,c=document.getElementById("workshopImageFile").files[0];if(!r||!s||!o||isNaN(a)||!n||!c){d("Please complete all required fields.","error");return}const u=new Image;u.src=URL.createObjectURL(c),u.onload=async function(){if(u.width>600||u.height>400){d("Image must be no larger than 600x400 pixels.","error");return}try{const m=`workshops/${t.uid}_${Date.now()}.jpg`,p=storageRef(storage,m);await uploadBytes(p,c);const g=await getDownloadURL(p),h=await D(k(y,"workshops"),{name:r,location:s,description:n,price:a,date:R.fromDate(new Date(o)),maxParticipants:i,image:g,createdBy:t.uid,createdAt:P(),status:"pending",approved:!1,tags:["submitted"]});console.log("Workshop submitted with ID:",h.id),d("Workshop submitted for approval!","success"),document.getElementById("submitWorkshopForm").reset(),I==null||I()}catch(m){console.error("Workshop submission error:",m),d("Failed to submit workshop.","error")}}}async function I(){const e=E.currentUser;if(!e)return;const t=document.getElementById("mySubmittedWorkshops");if(t){t.innerHTML=`
    <div class="flex justify-center items-center min-h-[100px]">
      <div class="w-8 h-8 border-4 border-t-transparent border-green-400 rounded-full animate-spin"></div>
    </div>
  `;try{const s=(await y.collection("workshops").where("createdBy","==",e.uid).get()).docs.map(o=>({id:o.id,slug:w(o.data().name),...o.data()}));if(t.innerHTML="",s.length===0){t.innerHTML='<p class="text-gray-400">No workshops submitted yet.</p>';return}s.forEach(o=>{const a=document.createElement("div");a.className="bg-gray-800 rounded-lg p-4 shadow relative";const n=document.createElement("img");n.src=o.image||"https://via.placeholder.com/600x400",n.className="w-full h-32 object-cover rounded mb-3";const i=document.createElement("h3");if(i.textContent=o.name,i.className="text-lg font-semibold mb-2",o.status!=="approved"){const f=document.createElement("span");f.textContent="Pending Review",f.className="ml-2 inline-block bg-yellow-400 text-black text-xs px-2 py-1 rounded-full align-middle",i.appendChild(f)}const c=document.createElement("p");c.textContent=`ðŸ“… ${new Date(o.date.seconds*1e3).toLocaleDateString()}`,c.className="text-gray-400 text-sm";const u=document.createElement("p");u.textContent=`Status: ${o.status||"pending"}`,u.className="text-xs text-yellow-400 mt-2";const l=document.createElement("p");l.textContent=`ðŸ”— /products/${o.slug||w(o.name)}`,l.className="text-xs text-gray-500 mt-1";const m=document.createElement("div");m.className="flex flex-wrap gap-2 mt-4";const p=document.createElement("button");p.textContent="Edit",p.className="bg-blue-600 px-3 py-1 rounded text-white text-sm hover:bg-blue-700",p.addEventListener("click",()=>Y(o));const g=document.createElement("button");g.textContent="Delete",g.className="bg-red-600 px-3 py-1 rounded text-white text-sm hover:bg-red-700",g.addEventListener("click",()=>z(o.id));const h=document.createElement("button");h.textContent="Copy Referral Link",h.className="bg-green-600 px-3 py-1 rounded text-white text-sm hover:bg-green-700",h.addEventListener("click",()=>me(o.id)),m.append(p,g,h),a.append(n,i,c,u,l,m),t.appendChild(a)})}catch(r){console.error("Error loading submitted workshops:",r),d("Failed to load your workshops.","error")}}}function Y(e){document.getElementById("editWorkshopId").value=e.id,document.getElementById("editWorkshopName").value=e.name||"",document.getElementById("editWorkshopName").dataset.original=e.name||"",document.getElementById("editWorkshopLocation").value=e.location||"",document.getElementById("editWorkshopLocation").dataset.original=e.location||"";const t=new Date(e.date.seconds*1e3).toISOString().substr(0,10);document.getElementById("editWorkshopDate").value=t,document.getElementById("editWorkshopDate").dataset.original=t,document.getElementById("editWorkshopPrice").value=e.price||"",document.getElementById("editWorkshopPrice").dataset.original=e.price||"",document.getElementById("editWorkshopDescription").value=e.description||"",document.getElementById("editWorkshopDescription").dataset.original=e.description||"",document.getElementById("editWorkshopSlug").value=e.slug||"",document.getElementById("editWorkshopSlug").dataset.original=e.slug||"",document.getElementById("editWorkshopShortDescription").value=e.shortDescription||"",document.getElementById("editWorkshopShortDescription").dataset.original=e.shortDescription||"",document.getElementById("editWorkshopDuration").value=e.duration||"",document.getElementById("editWorkshopDuration").dataset.original=e.duration||"",document.getElementById("editWorkshopMaxParticipants").value=e.maxParticipants||"",document.getElementById("editWorkshopMaxParticipants").dataset.original=e.maxParticipants||"",document.getElementById("editWorkshopFeatures").value=(e.features||[]).join(", "),document.getElementById("editWorkshopFeatures").dataset.original=(e.features||[]).join(", "),document.getElementById("editWorkshopImage").value="",document.getElementById("editWorkshopPreview").src=e.image||"https://via.placeholder.com/600x400";const r=document.getElementById("editWorkshopModal");r.classList.remove("hidden","opacity-0"),r.classList.add("opacity-100","transition-opacity","duration-300")}async function ue(){const e=document.getElementById("editWorkshopId").value;if(!e)return;const t=document.getElementById("editWorkshopName").value.trim(),r=document.getElementById("editWorkshopLocation").value.trim(),s=document.getElementById("editWorkshopDate").value,o=parseFloat(document.getElementById("editWorkshopPrice").value.trim()),a=document.getElementById("editWorkshopDescription").value.trim(),n=document.getElementById("editWorkshopSlug").value.trim().toLowerCase(),i=document.getElementById("editWorkshopShortDescription").value.trim(),c=document.getElementById("editWorkshopDuration").value.trim(),u=parseInt(document.getElementById("editWorkshopMaxParticipants").value.trim(),10)||null,l=document.getElementById("editWorkshopFeatures").value.trim();if(!t||!r||!s||isNaN(o)||!a){d("Please fill in all required fields.","error");return}const m=n||w(t);if(!oe(m)){d("Slug must only contain lowercase letters, numbers, and hyphens.","error");return}const p=S(k(y,"products"),B("slug","==",m)),g=await W(p);if(!g.empty&&g.docs[0].id!==e){d("This slug is already used by another product. Please update it.","error");return}const f=l?l.split(",").map(v=>v.trim()).filter(Boolean):[];try{const v=b(y,"workshops",e);await V(v,{name:t,location:r,price:o,description:a,shortDescription:i,duration:c,maxParticipants:u,features:f,slug:m,date:R.fromDate(new Date(s)),updatedAt:P()}),d("Workshop updated successfully!","success"),$(),I(),loadWorkshops==null||loadWorkshops()}catch(v){console.error("Error updating workshop:",v),d("Failed to update workshop.","error")}}function me(e){const t=E.currentUser;if(!t){d("Please login to generate your referral link.","error");return}const r=`${window.location.origin}/workshops?ref=${t.uid}&event=${e}`;navigator.clipboard.writeText(r).then(()=>d("Your referral link has been copied!","success")).catch(()=>d("Failed to copy link.","error"))}function $(){if(["editWorkshopName","editWorkshopLocation","editWorkshopDate","editWorkshopPrice","editWorkshopDescription"].some(r=>{const s=document.getElementById(r);return s.value!==s.dataset.original})&&!confirm("You have unsaved changes. Close without saving?"))return;const t=document.getElementById("editWorkshopModal");t.classList.remove("opacity-100"),t.classList.add("opacity-0"),setTimeout(()=>{t.classList.add("hidden")},300)}let O=[];function Ie(){var e,t,r,s;document.querySelectorAll(".affiliate-link").forEach(o=>{o.addEventListener("click",async a=>{var i;a.preventDefault();const n=o.getAttribute("href").replace("#","");document.querySelectorAll(".affiliate-tab").forEach(c=>c.classList.add("hidden")),(i=document.getElementById(n))==null||i.classList.remove("hidden"),n==="affiliateEarningsTab"?await x():n==="affiliateSettingsTab"?await te():n==="submitCourseProposalTab"?de():n==="mySubmittedCoursesTab"?ie():n==="submitWorkshopTab"?ce():n==="mySubmittedWorkshopsTab"&&F()})}),(e=document.querySelector(".affiliate-link"))==null||e.click(),(t=document.getElementById("exportPayoutsBtn"))==null||t.addEventListener("click",()=>ne(O)),(r=document.getElementById("applyFilterBtn"))==null||r.addEventListener("click",ge),(s=document.getElementById("filterType"))==null||s.addEventListener("change",pe)}async function x(e={}){const t=await X();O=t;const r=document.getElementById("payoutsContainer");r.innerHTML="";let s=t;if(e.month){const[a,n]=e.month.split("-");s=t.filter(i=>{const c=new Date(i.createdAt.seconds*1e3);return c.getFullYear()==a&&c.getMonth()+1==n})}else e.start&&e.end&&(s=t.filter(a=>{const n=new Date(a.createdAt.seconds*1e3);return n>=e.start&&n<=e.end}));if(!s.length){r.innerHTML='<p class="text-sm text-gray-500">No payouts match your filter.</p>';return}const o=s.reduce((a,n)=>a+(n.amount||0),0);r.innerHTML=`
  <div class="text-green-400 text-sm font-semibold mb-3">
    Total: $${o.toFixed(2)}
  </div>
`,s.forEach(a=>{const n=document.createElement("div");n.className="bg-gray-800 p-4 rounded shadow-sm flex justify-between items-center";const i=q(a.createdAt);n.innerHTML=`
      <div>
        <p class="text-white font-medium">Payout of $${(a.amount||0).toFixed(2)} AUD</p>
        <p class="text-sm text-gray-400">${i}</p>
      </div>
      <span class="text-green-400 text-sm font-mono">Stripe ID: ${a.stripePayoutId||"â€”"}</span>
    `,r.appendChild(n)})}function pe(e){const t=e.target.value;document.getElementById("monthInput").classList.toggle("hidden",t!=="monthly"),document.getElementById("financialYearInput").classList.toggle("hidden",t!=="financialYear")}function ge(){const e=document.getElementById("filterType").value;if(e==="monthly"){const t=document.getElementById("monthInput").value;t&&x({month:t})}else if(e==="financialYear"){const t=document.getElementById("financialYearInput").value,r=new Date(`${t}-07-01`),s=new Date(`${+t+1}-06-30`);x({start:r,end:s})}else x()}export{Ie as initAffiliateDashboard};
